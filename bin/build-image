#!/usr/bin/env bash

# Copyright 2011, Joyent. Inc. All rights reserved.

set -o errexit
set -o pipefail

timestamp=`date +%Y%m%d%H%M%S`

fatal() {
  printf "$(basename $0): fatal error: $*\n"
  exit 1
}

create_layout() {
  echo "==> Copying files and creating layout"
  [[ ! -d cache ]] && mkdir cache
  [[ ! -d cache/sdc-vmtools-lxbrand ]] && mkdir cache/sdc-vmtools-lxbrand
  cp -r layout/* cache/sdc-vmtools-lxbrand/
  cp -r src/linux cache/sdc-vmtools-lxbrand/
}

pack_tar() {
  echo "==> Creating tarball"
  cd cache
  tar -czf sdc-vmtools-lxbrand-$timestamp.tar.gz sdc-vmtools-lxbrand
  cd ../
}

create_zip() {
  echo "==> Creating zipfile"
  cd cache
  ZIP=`which zip`
  if [[ $? -ne 0 ]]; then
    echo "Cannot find a zip tool. Skipping zip file creation"
  else
    $ZIP -q -r sdc-vmtools-lxbrand-$timestamp.zip sdc-vmtools-lxbrand
  fi
  cd ../
}


pack_iso() {
  echo "==> Creating ISO"
  cd cache
  case `uname -s` in
    Darwin)
      hdiutil makehybrid -default-volume-name "SDC Guest Tools" -iso -joliet \
        -o sdc-vmtools-lxbrand-$timestamp.iso sdc-vmtools-lxbrand
      ;;
    SunOS)
      mkisofs -J -R -input-charset iso8859-1 -V "SDC Guest Tools" \
        -o sdc-vmtools-lxbrand-$timestamp.iso sdc-vmtools-lxbrand
      ;;
    *)
      fatal "Not a supported Operating system. Try it on OSX or SmartOS"
      ;;
  esac
  cd ../
}

# ensure we're always in the right working directory
cd $(dirname $0)/../
echo "==> Starting ISO build"
create_layout
pack_iso
pack_tar
create_zip
echo "==> DONE"
exit 0
